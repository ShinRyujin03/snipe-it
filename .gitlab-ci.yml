stages:
  - test
  - cleanup

variables:
  IMAGE_NAME: snipeit
  IMAGE_TAG: ci
  CONTAINER_NAME: snipeit-ci
  APP_PORT: 8080

test_snipeit:
  stage: test
  tags:
    - test
  script:
    - set -e

    - echo "=== CI CONTEXT ==="
    - pwd
    - ls -lah
    - test -f Dockerfile

    - echo "=== BUILD IMAGE ==="
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

    - echo "=== RUN CONTAINER ==="
    - docker rm -f ${CONTAINER_NAME} || true
    - docker run -d \
        --name ${CONTAINER_NAME} \
        -p ${APP_PORT}:80 \
        -e APP_ENV=testing \
        -e APP_DEBUG=true \
        -e DB_CONNECTION=sqlite \
        -e DB_DATABASE=/tmp/database.sqlite \
        ${IMAGE_NAME}:${IMAGE_TAG}

    - echo "=== WAIT FOR BOOT ==="
    - sleep 25

    - docker exec ${CONTAINER_NAME} php artisan key:generate --force
    - curl -f http://localhost:${APP_PORT}

cleanup_snipeit:
  stage: cleanup
  tags:
    - test
  when: always
  script:
    - echo "=== CONTAINER LOGS (ALWAYS) ==="
    - docker logs ${CONTAINER_NAME} || true

    - echo "=== CLEANUP (ALWAYS) ==="
    - docker rm -f ${CONTAINER_NAME} || true
