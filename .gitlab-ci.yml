stages:
  - test

variables:
  IMAGE_NAME: snipeit
  IMAGE_TAG: test
  CONTAINER_NAME: snipeit-test
  APP_PORT: 8080

test_snipeit:
  stage: test
  tags:
    - test

  script:
    - echo "=== DOCKER INFO ==="
    - docker info

    - echo "=== BUILD IMAGE ==="
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

    - echo "=== CLEAN OLD CONTAINER ==="
    - docker rm -f ${CONTAINER_NAME} || true

    - echo "=== RUN CONTAINER ==="
    - docker run -d \
        --name ${CONTAINER_NAME} \
        -p ${APP_PORT}:80 \
        -e APP_ENV=testing \
        -e APP_DEBUG=true \
        -e DB_CONNECTION=sqlite \
        -e DB_DATABASE=/tmp/database.sqlite \
        ${IMAGE_NAME}:${IMAGE_TAG}

    - echo "=== WAIT APP BOOT ==="
    - sleep 15

    - echo "=== HEALTH CHECK ==="
    - curl -I http://localhost:${APP_PORT}

  after_script:
    - echo "=== CONTAINER LOGS ==="
    - docker logs ${CONTAINER_NAME} || true

    - echo "=== CLEANUP ==="
    - docker rm -f ${CONTAINER_NAME} || true
