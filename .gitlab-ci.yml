stages:
  - test

# ======================
# GLOBAL VARIABLES
# ======================
variables:
  IMAGE_NAME: snipeit
  IMAGE_TAG: ci
  CONTAINER_NAME: snipeit-ci
  APP_PORT: 8080

# ======================
# TEST JOB
# ======================
test_snipeit:
  stage: test

  # ðŸ”‘ QUAN TRá»ŒNG NHáº¤T
  # Pháº£i match runner:
  # runner.tag_list = ["test"]
  tags:
    - test

  script:
    - set -e

    # ----------------------
    # CONTEXT DEBUG
    # ----------------------
    - echo "=== CI CONTEXT ==="
    - pwd
    - ls -lah
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Commit: $CI_COMMIT_SHA"

    # ----------------------
    # DOCKER CHECK
    # ----------------------
    - echo "=== DOCKER INFO ==="
    - docker info

    # ----------------------
    # VALIDATE DOCKERFILE
    # (repo cá»§a báº¡n Ä‘áº·t Dockerfile á»Ÿ root)
    # ----------------------
    - test -f Dockerfile

    # ----------------------
    # BUILD IMAGE
    # ----------------------
    - echo "=== BUILD IMAGE ==="
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

    # ----------------------
    # CLEAN OLD CONTAINER
    # ----------------------
    - echo "=== CLEAN OLD CONTAINER ==="
    - docker rm -f ${CONTAINER_NAME} || true

    # ----------------------
    # RUN CONTAINER
    # ----------------------
    - echo "=== RUN CONTAINER ==="
    - docker run -d \
        --name ${CONTAINER_NAME} \
        -p ${APP_PORT}:80 \
        -e APP_ENV=testing \
        -e APP_DEBUG=true \
        -e DB_CONNECTION=sqlite \
        -e DB_DATABASE=/tmp/database.sqlite \
        ${IMAGE_NAME}:${IMAGE_TAG}

    # ----------------------
    # WAIT FOR BOOT
    # ----------------------
    - echo "=== WAIT FOR APP BOOT ==="
    - sleep 25

    # ----------------------
    # LARAVEL SETUP
    # ----------------------
    - echo "=== GENERATE APP KEY ==="
    - docker exec ${CONTAINER_NAME} php artisan key:generate --force

    # ----------------------
    # HEALTH CHECK
    # ----------------------
    - echo "=== HEALTH CHECK ==="
    - curl -f http://localhost:${APP_PORT}

  # ======================
  # ALWAYS RUN (Ká»‚ Cáº¢ FAIL)
  # ======================
  after_script:
    - echo "=== CONTAINER LOGS (ALWAYS) ==="
    - docker logs ${CONTAINER_NAME} || true

    - echo "=== CLEANUP (ALWAYS) ==="
    - docker rm -f ${CONTAINER_NAME} || true
