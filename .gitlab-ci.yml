stages:
  - deploy

deploy_to_test_vm:
  stage: deploy
  tags:
    - test        # đúng tag runner của bạn
  only:
    - internal-deploy

  variables:
    VM_USER: ptcn-qlda
    VM_HOST: 10.2.X.X          # IP VM TEST
    APP_NAME: snipeit
    APP_PORT: 8080

  before_script:
    - which ssh
    - mkdir -p ~/.ssh
    - echo "$VM_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts

  script:
    - |
      ssh $VM_USER@$VM_HOST << 'EOF'
        set -e

        APP_NAME="snipeit"
        APP_PORT=8080
        DB_NAME="snipeit"
        DB_USER="snipeit"
        DB_PASS="snipeit"

        echo "=== STOP OLD CONTAINERS ==="
        docker rm -f $APP_NAME || true
        docker rm -f $APP_NAME-mysql || true

        echo "=== CREATE NETWORK ==="
        docker network create $APP_NAME-net || true

        echo "=== START MYSQL ==="
        docker run -d \
          --name $APP_NAME-mysql \
          --network $APP_NAME-net \
          -e MYSQL_ROOT_PASSWORD=root \
          -e MYSQL_DATABASE=$DB_NAME \
          -e MYSQL_USER=$DB_USER \
          -e MYSQL_PASSWORD=$DB_PASS \
          mysql:8.0 \
          --default-authentication-plugin=mysql_native_password

        echo "=== WAIT MYSQL ==="
        sleep 20

        echo "=== START SNIPE-IT ==="
        docker run -d \
          --name $APP_NAME \
          --network $APP_NAME-net \
          -p $APP_PORT:80 \
          -e APP_ENV=production \
          -e APP_DEBUG=false \
          -e APP_URL=http://$VM_HOST:$APP_PORT \
          -e DB_HOST=$APP_NAME-mysql \
          -e DB_DATABASE=$DB_NAME \
          -e DB_USERNAME=$DB_USER \
          -e DB_PASSWORD=$DB_PASS \
          snipe/snipe-it:latest

        echo "=== VERIFY ==="
        docker ps | grep $APP_NAME
      EOF
