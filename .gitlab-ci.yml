stages:
  - build
  - test

variables:
  IMAGE_NAME: snipeit
  IMAGE_TAG: test

build_image:
  stage: build
  tags:
    - test
  script:
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

run_test:
  stage: test
  tags:
    - test
  script:
    - docker stop snipeit-test || true
    - docker rm snipeit-test || true
    - docker run -d \
        --name snipeit-test \
        -p 8080:80 \
        --env-file .env.test \
        ${IMAGE_NAME}:${IMAGE_TAG}
    - sleep 10
    - curl -I http://localhost:8080
